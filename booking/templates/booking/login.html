{% extends 'base.html' %}

{% block title %}登录切换{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="login-container">
        <!-- 登录方式切换标签 -->
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#code-login">验证码登录</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#password-login">密码登录</a>
            </li>
        </ul>

        <!-- 地区限制提示 -->
        <div class="text-muted small mb-3">你所在地区仅支持手机号登录</div>

        <!-- 登录内容区域 -->
        <div class="tab-content">
            <!-- 验证码登录 -->
            <div class="tab-pane fade show active" id="code-login">
                <form method="post" action="{% url 'login' %}">
                    {% csrf_token %}
                    <input type="hidden" name="login_type" value="code">
                    <div class="mb-3 input-group">
                        <span class="input-group-text" style="width: 60px;">+86</span>
                        <input type="tel" class="form-control" name="phone" 
                               id="phone-input" 
                               placeholder="请输入11位手机号" 
                               maxlength="11"
                               pattern="^1[3-9]\d{9}$"
                               required>
                        <div id="phone-error" class="invalid-feedback">请输入有效的手机号</div>
                    </div>
                    <div class="mb-3 input-group">
                        <input type="text" class="form-control" name="code" placeholder="请输入验证码" required>
                        <button type="button" class="btn btn-outline-secondary send-code-btn">发送验证码</button>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">登录</button>
                </form>
                <div class="text-muted small mt-3">未注册的手机号将自动注册</div>
            </div>

            <!-- 密码登录 -->
            <div class="tab-pane fade" id="password-login">
                <form method="post" action="{% url 'login' %}">
                    {% csrf_token %}
                    <input type="hidden" name="login_type" value="password">
                    <div class="mb-3 input-group">
                        <span class="input-group-text" style="width: 60px;">+86</span>
                        <input type="tel" class="form-control" name="phone" 
                               id="phone-input-password" 
                               placeholder="请输入11位手机号" 
                               maxlength="11"
                               pattern="^1[3-9]\d{9}$"
                               required>
                        <div id="phone-error-password" class="invalid-feedback">请输入有效的手机号</div>
                    </div>
                    <div class="mb-3 input-group">
                        <input type="password" class="form-control" name="password" placeholder="请输入密码" required>
                        <span class="input-group-text" style="cursor: pointer;"><i class="bi bi-eye"></i></span>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">登录</button>
                </form>
                <div class="d-flex justify-content-between mt-3">
                    <a href="{% url 'password_reset' %}" class="text-muted small">忘记密码</a>
                    <a href="#" class="text-muted small">立即注册</a>
                </div>
            </div>
        </div>

        <!-- 协议声明 -->
        <div class="text-center small mt-4">
            注册登录即代表同意 <a href="{% url 'terms' %}" class="text-primary">用户协议</a> 与 <a href="{% url 'privacy' %}" class="text-primary">隐私政策</a>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS 及依赖 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 自定义交互逻辑 -->
<script>
    // 手机号验证 - 验证码登录
    const phoneInput = document.getElementById('phone-input');
    // 手机号验证 - 密码登录
    const phoneInputPassword = document.getElementById('phone-input-password');
    
    // Track previous valid value for each input
    const previousValues = new WeakMap();
    
    function validatePhoneInput(e) {
        const input = e.target;
        const value = input.value;
        const cursorPos = input.selectionStart;
        const errorElement = document.getElementById(input.id === 'phone-input' ? 'phone-error' : 'phone-error-password');
        
        // Immediately filter out non-digit characters
        const filteredValue = value.replace(/\D/g, '');
        
        // If value changed after filtering (had non-digits)
        if (value !== filteredValue) {
            // Show error message
            errorElement.textContent = '只能输入数字';
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 2000);
            
            // Update input with filtered value
            input.value = filteredValue.substring(0, 11);
            
            // Adjust cursor position
            const newCursorPos = Math.max(0, cursorPos - (value.length - filteredValue.length));
            input.setSelectionRange(newCursorPos, newCursorPos);
            return;
        }
        
        // Enforce 11-digit limit
        input.value = filteredValue.substring(0, 11);
        
        // Validate phone format
        const isValid = /^1[3-9]\d{9}$/.test(filteredValue);
        e.target.classList.toggle('is-invalid', !isValid && filteredValue.length === 11);
        
        // Update error message for invalid phone format
        if (filteredValue.length === 11 && !isValid) {
            errorElement.textContent = '请输入有效的手机号码';
            errorElement.style.display = 'block';
        } else if (value === filteredValue) {
            errorElement.style.display = 'none';
        }
        
        // Update send button state
        if (e.target.id === 'phone-input') {
            document.querySelector('.send-code-btn').disabled = !isValid;
        }
    }

    // 为两个手机号输入框添加事件监听
    [phoneInput, phoneInputPassword].forEach(input => {
        // Track IME composition state
        input.composing = false;
        input.addEventListener('compositionstart', () => {
            input.composing = true;
            previousValues.set(input, input.value);
        });
        input.addEventListener('compositionend', (e) => {
            input.composing = false;
            validatePhoneInput(e);
        });
        input.addEventListener('input', validatePhoneInput);
    });

    // 提交表单时确保发送原始值
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const phoneInput = this.querySelector('input[name="phone"]');
            if (phoneInput && phoneInput.dataset.rawValue) {
                phoneInput.value = phoneInput.dataset.rawValue;
            }
        });
    });

    // 验证码发送倒计时与阿里云短信集成
    document.querySelector('.send-code-btn').addEventListener('click', async function() {
        const phoneInput = document.getElementById('phone-input');
        const phone = phoneInput.dataset.rawValue || phoneInput.value.replace(/\D/g, '');
        const btn = this;
        
        if (!/^1[3-9]\d{9}$/.test(phone)) {
            phoneInput.classList.add('is-invalid');
            document.getElementById('phone-error').textContent = '请输入有效的手机号码';
            document.getElementById('phone-error').style.display = 'block';
            return;
        }

        btn.disabled = true;
        let seconds = 60;
        const timer = setInterval(() => {
            btn.textContent = `重新发送(${seconds}s)`;
            seconds--;
            if (seconds < 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = '发送验证码';
            }
        }, 1000);
        
        try {
            const response = await fetch("{% url 'send_code' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    phone: phone
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = '发送验证码';
                document.getElementById('phone-error').textContent = result.message || '发送验证码失败';
                document.getElementById('phone-error').style.display = 'block';
            }
        } catch (error) {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = '发送验证码';
            alert('发送验证码失败: ' + error.message);
        }
    });

    // 密码显示切换
    document.querySelectorAll('.input-group-text').forEach(icon => {
        icon.addEventListener('click', () => {
            const input = icon.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
        });
    });
</script>

{% endblock %}
